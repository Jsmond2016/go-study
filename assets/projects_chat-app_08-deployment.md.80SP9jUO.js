import{_ as a,c as i,o as n,ag as l}from"./chunks/framework.mZxFZN4m.js";const E=JSON.parse('{"title":"éƒ¨ç½²ä¼˜åŒ–","description":"","frontmatter":{"title":"éƒ¨ç½²ä¼˜åŒ–","difficulty":"intermediate","duration":"2-3å°æ—¶","prerequisites":["æ¶ˆæ¯æ¨é€"],"tags":["éƒ¨ç½²","Docker","æ€§èƒ½ä¼˜åŒ–","ç›‘æ§"]},"headers":[],"relativePath":"projects/chat-app/08-deployment.md","filePath":"projects/chat-app/08-deployment.md","lastUpdated":1763896864000}'),e={name:"projects/chat-app/08-deployment.md"};function t(p,s,h,k,r,c){return n(),i("div",null,[...s[0]||(s[0]=[l(`<h1 id="éƒ¨ç½²ä¼˜åŒ–" tabindex="-1">éƒ¨ç½²ä¼˜åŒ– <a class="header-anchor" href="#éƒ¨ç½²ä¼˜åŒ–" aria-label="Permalink to &quot;éƒ¨ç½²ä¼˜åŒ–&quot;">â€‹</a></h1><p>æœ¬ç« èŠ‚å°†ä»‹ç»èŠå¤©åº”ç”¨çš„éƒ¨ç½²æ–¹æ¡ˆã€æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§é…ç½®ã€‚</p><h2 id="ğŸ“‹-å­¦ä¹ ç›®æ ‡" tabindex="-1">ğŸ“‹ å­¦ä¹ ç›®æ ‡ <a class="header-anchor" href="#ğŸ“‹-å­¦ä¹ ç›®æ ‡" aria-label="Permalink to &quot;ğŸ“‹ å­¦ä¹ ç›®æ ‡&quot;">â€‹</a></h2><p>å®Œæˆæœ¬ç« èŠ‚åï¼Œä½ å°†èƒ½å¤Ÿï¼š</p><ul class="contains-task-list"><li class="task-list-item enabled"><input class="task-list-item-checkbox" type="checkbox"> ä½¿ç”¨Dockerå®¹å™¨åŒ–åº”ç”¨</li><li class="task-list-item enabled"><input class="task-list-item-checkbox" type="checkbox"> é…ç½®WebSocketè´Ÿè½½å‡è¡¡</li><li class="task-list-item enabled"><input class="task-list-item-checkbox" type="checkbox"> å®ç°è¿æ¥æ± ç®¡ç†</li><li class="task-list-item enabled"><input class="task-list-item-checkbox" type="checkbox"> é…ç½®ç›‘æ§å’Œæ—¥å¿—</li><li class="task-list-item enabled"><input class="task-list-item-checkbox" type="checkbox"> è¿›è¡Œæ€§èƒ½è°ƒä¼˜</li></ul><h2 id="ğŸ³-docker-éƒ¨ç½²" tabindex="-1">ğŸ³ Docker éƒ¨ç½² <a class="header-anchor" href="#ğŸ³-docker-éƒ¨ç½²" aria-label="Permalink to &quot;ğŸ³ Docker éƒ¨ç½²&quot;">â€‹</a></h2><h3 id="dockerfile" tabindex="-1">Dockerfile <a class="header-anchor" href="#dockerfile" aria-label="Permalink to &quot;Dockerfile&quot;">â€‹</a></h3><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> golang:1.21-alpine </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> go.mod go.sum ./</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> go mod download</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> . .</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CGO_ENABLED=0 GOOS=linux go build -o chat-app cmd/server/main.go</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> alpine:latest</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apk --no-cache add ca-certificates</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=builder /app/chat-app .</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EXPOSE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 8080</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./chat-app&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="âš¡-æ€§èƒ½ä¼˜åŒ–" tabindex="-1">âš¡ æ€§èƒ½ä¼˜åŒ– <a class="header-anchor" href="#âš¡-æ€§èƒ½ä¼˜åŒ–" aria-label="Permalink to &quot;âš¡ æ€§èƒ½ä¼˜åŒ–&quot;">â€‹</a></h2><h3 id="websocketè¿æ¥æ± " tabindex="-1">WebSocketè¿æ¥æ±  <a class="header-anchor" href="#websocketè¿æ¥æ± " aria-label="Permalink to &quot;WebSocketè¿æ¥æ± &quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é™åˆ¶æ¯ä¸ªç”¨æˆ·çš„è¿æ¥æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Hub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RegisterClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	h.mu.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	defer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h.mu.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰è¿æ¥</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	existingConnections </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h.clients {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.UserID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> client.UserID {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			existingConnections</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> existingConnections </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		client.Conn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	h.clients[client] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="ğŸ“Š-ç›‘æ§é…ç½®" tabindex="-1">ğŸ“Š ç›‘æ§é…ç½® <a class="header-anchor" href="#ğŸ“Š-ç›‘æ§é…ç½®" aria-label="Permalink to &quot;ğŸ“Š ç›‘æ§é…ç½®&quot;">â€‹</a></h2><h3 id="è¿æ¥æ•°ç›‘æ§" tabindex="-1">è¿æ¥æ•°ç›‘æ§ <a class="header-anchor" href="#è¿æ¥æ•°ç›‘æ§" aria-label="Permalink to &quot;è¿æ¥æ•°ç›‘æ§&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	activeConnections </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prometheus.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NewGauge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		prometheus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GaugeOpts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;websocket_connections_active&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Help: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å½“å‰æ´»è·ƒçš„WebSocketè¿æ¥æ•°&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="ğŸ’¡-æœ€ä½³å®è·µ" tabindex="-1">ğŸ’¡ æœ€ä½³å®è·µ <a class="header-anchor" href="#ğŸ’¡-æœ€ä½³å®è·µ" aria-label="Permalink to &quot;ğŸ’¡ æœ€ä½³å®è·µ&quot;">â€‹</a></h2><h3 id="_1-è¿æ¥ç®¡ç†" tabindex="-1">1. è¿æ¥ç®¡ç† <a class="header-anchor" href="#_1-è¿æ¥ç®¡ç†" aria-label="Permalink to &quot;1. è¿æ¥ç®¡ç†&quot;">â€‹</a></h3><ul><li>é™åˆ¶æ¯ä¸ªç”¨æˆ·çš„è¿æ¥æ•°</li><li>å®ç°è¿æ¥è¶…æ—¶æœºåˆ¶</li><li>ä½¿ç”¨è¿æ¥æ± ç®¡ç†</li></ul><h3 id="_2-æ¶ˆæ¯å¤„ç†" tabindex="-1">2. æ¶ˆæ¯å¤„ç† <a class="header-anchor" href="#_2-æ¶ˆæ¯å¤„ç†" aria-label="Permalink to &quot;2. æ¶ˆæ¯å¤„ç†&quot;">â€‹</a></h3><ul><li>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¤§é‡æ¶ˆæ¯</li><li>å®ç°æ¶ˆæ¯æ‰¹é‡å¤„ç†</li><li>ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢</li></ul><h3 id="_3-æ‰©å±•æ€§" tabindex="-1">3. æ‰©å±•æ€§ <a class="header-anchor" href="#_3-æ‰©å±•æ€§" aria-label="Permalink to &quot;3. æ‰©å±•æ€§&quot;">â€‹</a></h3><ul><li>ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼</li><li>å®ç°æ°´å¹³æ‰©å±•</li><li>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦</li></ul><hr><p><strong>ğŸ‰ éƒ¨ç½²ä¼˜åŒ–å®Œæˆï¼</strong> æ­å–œä½ å®Œæˆäº†æ•´ä¸ªèŠå¤©åº”ç”¨çš„å¼€å‘ï¼</p>`,23)])])}const o=a(e,[["render",t]]);export{E as __pageData,o as default};
